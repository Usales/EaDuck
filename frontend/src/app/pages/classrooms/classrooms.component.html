<app-sidebar></app-sidebar>
<div class="classrooms-container page-bg">
  <!-- Header Mobile First -->
  <div class="classrooms-header">
    <div class="classrooms-header-content">
      <h1 class="classrooms-title">Salas</h1>
      <button *ngIf="isAdminOrTeacher" (click)="toggleNewClassroomForm()" class="classrooms-add-btn">
        <span class="material-icons">{{ showNewClassroomForm ? 'close' : 'add' }}</span>
        <span class="classrooms-add-text">{{ showNewClassroomForm ? 'Cancelar' : 'Nova Sala' }}</span>
      </button>
    </div>
  </div>

  <!-- Formulário de Nova Sala Mobile First -->
  <div *ngIf="isAdminOrTeacher && showNewClassroomForm" class="classrooms-form">
    <h2 class="classrooms-form-title">Criar Nova Sala</h2>
    <div class="classrooms-form-grid">
      <div class="classrooms-form-field">
        <label class="classrooms-form-label">Nome da Sala <span class="text-red-500">*</span></label>
        <div class="classrooms-form-input-wrapper">
          <span class="classrooms-form-icon">
            <span class="material-icons">school</span>
          </span>
          <input type="text" placeholder="Digite o nome da sala" [(ngModel)]="newName" class="classrooms-form-input">
        </div>
      </div>
      
      <div class="classrooms-form-field">
        <label class="classrooms-form-label">Ano Letivo <span class="text-red-500">*</span></label>
        <div class="classrooms-form-input-wrapper">
          <span class="classrooms-form-icon">
            <span class="material-icons">calendar_today</span>
          </span>
          <input type="text" placeholder="Ex: 2025" [(ngModel)]="newAcademicYear" (input)="onYearInput($event, 'new')" (keypress)="onKeyPress($event)" maxlength="4" class="classrooms-form-input">
        </div>
      </div>
      
      <div class="classrooms-form-actions">
        <button (click)="createClassroom()" class="classrooms-form-submit">
          <span class="material-icons">add</span>
          Criar Sala
        </button>
      </div>
    </div>
  </div>

  <!-- Barra de Busca -->
  <div class="classrooms-search">
    <div class="classrooms-search-wrapper">
      <span class="classrooms-search-icon">
        <span class="material-icons">search</span>
      </span>
      <input type="text" placeholder="Buscar salas..." [(ngModel)]="filter" (input)="applyFilter()" class="classrooms-search-input">
    </div>
  </div>
  <!-- Lista de Salas Mobile First -->
  <div class="classrooms-list">
    <div class="classrooms-grid">
      <div *ngFor="let classroom of filteredClassrooms" class="classroom-card">
        <!-- Header do Card -->
        <div class="classroom-card-header">
          <div class="classroom-card-info">
            <ng-container *ngIf="editClassroomId === classroom.id; else viewName">
              <input [(ngModel)]="editName" class="classroom-card-name-input" />
            </ng-container>
            <ng-template #viewName>
              <h3 class="classroom-card-name">{{ classroom.name }}</h3>
            </ng-template>
          </div>
          <div class="classroom-card-status">
            <span [ngClass]="classroom.isActive !== false ? 'classroom-status-active' : 'classroom-status-inactive'">
              {{ classroom.isActive !== false ? 'Ativa' : 'Inativa' }}
            </span>
          </div>
        </div>

        <!-- Body do Card -->
        <div class="classroom-card-body">
          <div class="classroom-card-field">
            <span class="classroom-card-label">Ano letivo:</span>
            <ng-container *ngIf="editClassroomId === classroom.id; else viewYear">
              <input type="text" [(ngModel)]="editAcademicYear" (input)="onYearInput($event, 'edit')" (keypress)="onKeyPress($event)" maxlength="4" class="classroom-card-input" />
            </ng-container>
            <ng-template #viewYear>
              <span class="classroom-card-value">{{ classroom.academicYear }}</span>
            </ng-template>
          </div>

          <div class="classroom-card-field">
            <span class="classroom-card-label">Professores:</span>
            <span class="classroom-card-value" *ngIf="(classroom.teacherNames?.length ?? 0) === 0">Nenhum professor atribuído</span>
            <span class="classroom-card-value" *ngIf="(classroom.teacherNames?.length ?? 0) > 0">{{ (classroom.teacherNames ?? []).join(', ') }}</span>
          </div>

          <div class="classroom-card-stats">
            <div class="classroom-stat">
              <span class="material-icons">people</span>
              <span>{{ classroom.studentCount }} alunos</span>
            </div>
          </div>
        </div>

        <!-- Ações de Atribuição -->
        <div *ngIf="isAdminOrTeacher" class="classroom-card-assignments">
          <button *ngIf="currentUser?.role === 'ADMIN'" (click)="openAssignTeacher(classroom)" class="classroom-assign-btn classroom-assign-teacher">
            <span class="material-icons">person_add</span>
            Professores
          </button>
          <button (click)="openAssignStudent(classroom)" class="classroom-assign-btn classroom-assign-student">
            <span class="material-icons">group_add</span>
            Alunos
          </button>
        </div>

        <!-- Ações de Edição/Exclusão -->
        <div class="classroom-card-actions">
          <ng-container *ngIf="editClassroomId === classroom.id && isAdminOrTeacher; else editDeleteBtns">
            <button (click)="saveEdit(classroom)" class="classroom-action-btn classroom-action-save">
              <span class="material-icons">check</span>
              Salvar
            </button>
            <button (click)="cancelEdit()" class="classroom-action-btn classroom-action-cancel">
              <span class="material-icons">close</span>
              Cancelar
            </button>
          </ng-container>
           <ng-template #editDeleteBtns>
             <button *ngIf="isAdminOrTeacher" (click)="exportClassroomUsersToPdf(classroom)" class="classroom-action-btn classroom-action-pdf">
               <span class="material-icons">picture_as_pdf</span>
               Dados PDF
             </button>
             <button *ngIf="isAdminOrTeacher && currentUser?.role === 'ADMIN'" (click)="startEdit(classroom)" class="classroom-action-btn classroom-action-edit">
               <span class="material-icons">edit</span>
               Editar
             </button>
             <button *ngIf="isAdminOrTeacher && currentUser?.role === 'ADMIN'" (click)="deleteClassroom(classroom)" class="classroom-action-btn classroom-action-delete">
               <span class="material-icons">delete</span>
               Excluir
             </button>
             <button *ngIf="isAdminOrTeacher" (click)="openNotasPdfModal(classroom)" class="classroom-action-btn classroom-action-pdf">
               <span class="material-icons">description</span>
               Notas PDF
             </button>
           </ng-template>
        </div>
        <!-- Atribuição de Professores -->
        <div *ngIf="assignClassroomId === classroom.id && assignMode === 'teacher'" class="classroom-assignment">
          <h4 class="classroom-assignment-title">Atribuir Professores</h4>
          
          <div class="classroom-assignment-selected">
            <div *ngIf="selectedTeacherIds.length === 0" class="classroom-assignment-empty">
              Nenhum professor selecionado
            </div>
            <div *ngIf="selectedTeacherIds.length > 0" class="classroom-assignment-tags">
              <span *ngFor="let id of selectedTeacherIds" class="classroom-assignment-tag classroom-assignment-tag-teacher">
                {{ getTeacherNameById(id) }}
                <button (click)="removeTeacherFromSelection(id)" class="classroom-assignment-tag-remove">&times;</button>
              </span>
            </div>
          </div>

          <div class="classroom-assignment-search">
            <input 
              #teacherSearchInput
              type="text" 
              [(ngModel)]="searchTeacher" 
              (input)="filterTeachers()" 
              (focus)="filterTeachers()"
              placeholder="Digite o nome completo ou email do professor..." 
              class="classroom-assignment-input"
              autocomplete="off"
            />
          </div>

          <div *ngIf="searchTeacher && searchTeacher.length > 0 && filteredTeachers.length > 0" class="classroom-assignment-results">
            <div *ngFor="let teacher of filteredTeachers" (click)="addTeacherToSelection(teacher)" class="classroom-assignment-item">
              <div class="classroom-assignment-item-name">{{ teacher.nomeCompleto || teacher.name || teacher.email }}</div>
              <div class="classroom-assignment-item-email" *ngIf="teacher.nomeCompleto || teacher.name">{{ teacher.email }}</div>
            </div>
          </div>
          <div *ngIf="searchTeacher && searchTeacher.length > 0 && filteredTeachers.length === 0 && teachers.length > 0" class="classroom-assignment-empty">
            Nenhum professor encontrado
          </div>
          <div *ngIf="(!searchTeacher || searchTeacher.length === 0) && teachers.length > 0" class="classroom-assignment-empty">
            Digite o nome completo ou email para buscar professores
          </div>
          <div *ngIf="teachers.length === 0" class="classroom-assignment-empty">
            Carregando professores...
          </div>

          <div class="classroom-assignment-actions">
            <button (click)="saveTeachers()" [disabled]="selectedTeacherIds.length === 0" class="classroom-assignment-btn classroom-assignment-save">
              <span class="material-icons">check</span>
              Salvar
            </button>
            <button (click)="cancelAssignTeacher()" class="classroom-assignment-btn classroom-assignment-cancel">
              <span class="material-icons">close</span>
              Cancelar
            </button>
          </div>
        </div>

        <!-- Atribuição de Alunos -->
        <div *ngIf="assignClassroomId === classroom.id && assignMode === 'student'" class="classroom-assignment">
          <h4 class="classroom-assignment-title">Atribuir Alunos</h4>
          
          <div class="classroom-assignment-selected">
            <div *ngIf="selectedStudentIds.length === 0" class="classroom-assignment-empty">
              Nenhum aluno selecionado
            </div>
            <div *ngIf="selectedStudentIds.length > 0" class="classroom-assignment-tags">
              <span *ngFor="let id of selectedStudentIds" class="classroom-assignment-tag classroom-assignment-tag-student">
                {{ getStudentNameById(id) }}
                <button (click)="removeStudentFromSelection(id)" class="classroom-assignment-tag-remove">&times;</button>
              </span>
            </div>
          </div>

          <div class="classroom-assignment-search">
            <input 
              #studentSearchInput
              type="text" 
              [(ngModel)]="searchStudent" 
              (input)="filterStudents()" 
              (focus)="filterStudents()"
              placeholder="Digite o nome completo ou email do aluno..." 
              class="classroom-assignment-input"
              autocomplete="off"
            />
          </div>

          <div *ngIf="searchStudent && searchStudent.length > 0 && filteredStudents.length > 0" class="classroom-assignment-results">
            <div *ngFor="let student of filteredStudents" (click)="addStudentToSelection(student)" class="classroom-assignment-item">
              <div class="classroom-assignment-item-name">{{ student.nomeCompleto || student.name || student.email }}</div>
              <div class="classroom-assignment-item-email" *ngIf="student.nomeCompleto || student.name">{{ student.email }}</div>
            </div>
          </div>
          <div *ngIf="searchStudent && searchStudent.length > 0 && filteredStudents.length === 0 && students.length > 0" class="classroom-assignment-empty">
            Nenhum aluno encontrado
          </div>
          <div *ngIf="(!searchStudent || searchStudent.length === 0) && students.length > 0" class="classroom-assignment-empty">
            Digite o nome completo ou email para buscar alunos
          </div>
          <div *ngIf="students.length === 0" class="classroom-assignment-empty">
            Carregando alunos...
          </div>

          <div class="classroom-assignment-actions">
            <button (click)="saveStudents()" [disabled]="selectedStudentIds.length === 0" class="classroom-assignment-btn classroom-assignment-save">
              <span class="material-icons">check</span>
              Salvar
            </button>
            <button (click)="cancelAssignStudent()" class="classroom-assignment-btn classroom-assignment-cancel">
              <span class="material-icons">close</span>
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Seleção de Aluno - Notas PDF -->
  <div *ngIf="showNotasPdfModal" class="modal-overlay" (click)="closeNotasPdfModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Selecionar Aluno para Gerar Notas PDF</h3>
        <button (click)="closeNotasPdfModal()" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div *ngIf="notasPdfClassroom && notasPdfClassroom.students && notasPdfClassroom.students.length > 0">
          <div class="student-list">
            <div *ngFor="let student of notasPdfClassroom.students" 
                 (click)="exportStudentGradesToPdf(notasPdfClassroom.id, student.id)" 
                 class="student-item">
              <div class="student-name">{{ student.nomeCompleto || student.name || student.email }}</div>
              <div class="student-email" *ngIf="student.nomeCompleto || student.name">{{ student.email }}</div>
            </div>
          </div>
        </div>
        <div *ngIf="!notasPdfClassroom || !notasPdfClassroom.students || notasPdfClassroom.students.length === 0" class="empty-state">
          Nenhum aluno encontrado nesta sala.
        </div>
      </div>
    </div>
  </div>
</div>
