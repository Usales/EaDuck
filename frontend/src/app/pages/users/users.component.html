<app-sidebar></app-sidebar>
<div class="users-container page-bg">
  <!-- Header Mobile First -->
  <div class="users-header">
    <div class="users-header-content">
      <h1 class="users-title">Usuários</h1>
      <button *ngIf="isAdmin" (click)="toggleNewUserForm()" class="users-add-btn">
        <span class="material-icons">{{ showNewUserForm ? 'close' : 'add' }}</span>
        <span class="users-add-text">{{ showNewUserForm ? 'Cancelar' : 'Novo Usuário' }}</span>
      </button>
    </div>
  </div>

  <!-- Formulário de Novo Usuário Mobile First -->
  <div *ngIf="isAdmin && showNewUserForm" class="users-form">
    <h2 class="users-form-title">Criar Novo Usuário</h2>
    <div class="users-form-grid">
      <div class="users-form-field">
        <label class="users-form-label">E-mail <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">email</span>
          </span>
          <input type="email" [(ngModel)]="newUser.email" 
                 class="users-form-input"
                 placeholder="Digite o e-mail">
        </div>
      </div>
      
      <div class="users-form-field">
        <label class="users-form-label">Senha <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">lock</span>
          </span>
          <input type="password" [(ngModel)]="newUser.password" 
                 class="users-form-input"
                 placeholder="Digite a senha">
        </div>
        <div class="users-form-password-strength">
          <div class="users-form-strength-bar"
               [ngClass]="{
                 'strength-weak': passwordStrength <= 1,
                 'strength-medium': passwordStrength === 2,
                 'strength-strong': passwordStrength === 3 || passwordStrength === 4,
                 'strength-very-strong': passwordStrength === 5
               }"
               [style.width]="(passwordStrength * 20) + '%'">
          </div>
          <span class="users-form-strength-text" [ngClass]="{
            'text-red-400': passwordStrength <= 1,
            'text-yellow-400': passwordStrength === 2,
            'text-green-400': passwordStrength === 3 || passwordStrength === 4,
            'text-blue-400': passwordStrength === 5
          }">Força da senha: {{ passwordStrengthLabel }}</span>
        </div>
        <p class="users-form-help">A senha deve ter pelo menos 6 caracteres</p>
      </div>
      
      <div class="users-form-field">
        <label class="users-form-label">Tipo de Usuário <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">person</span>
          </span>
          <select [(ngModel)]="newUser.role" class="users-form-select">
            <option value="ADMIN">Admin</option>
            <option value="STUDENT">Aluno</option>
            <option value="TEACHER">Professor</option>
          </select>
          <span class="users-form-select-arrow">
            <span class="material-icons">arrow_drop_down</span>
          </span>
        </div>
      </div>
      
      <div class="users-form-actions">
        <button (click)="createUser()" class="users-form-submit">
          <span class="material-icons">save</span>
          Criar Usuário
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de Usuários Mobile First -->
  <div class="users-list">
    <!-- Barra de Busca -->
    <div class="users-search">
      <div class="users-search-wrapper">
        <span class="users-search-icon">
          <span class="material-icons">search</span>
        </span>
        <input type="text" placeholder="Buscar usuários..." [(ngModel)]="filter" (input)="applyFilter()" class="users-search-input">
      </div>
    </div>

    <!-- Cards Mobile / Tabela Desktop -->
    <div class="users-content">
      <!-- Cards para Mobile -->
      <div class="users-cards-mobile">
        <div *ngFor="let user of filteredUsers" class="users-card">
          <div class="users-card-header">
            <div class="users-card-info">
              <h3 class="users-card-email">{{ user.email }}</h3>
              <span class="users-card-id">ID: {{ user.id }}</span>
            </div>
            <div class="users-card-status">
              <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                {{ user.isActive ? 'Ativo' : 'Inativo' }}
              </span>
            </div>
          </div>
          
          <div class="users-card-body">
            <div class="users-card-field">
              <span class="users-card-label">Tipo:</span>
              <ng-container *ngIf="editUserId === user.id; else viewRole">
                <select [(ngModel)]="editRole" 
                        [disabled]="!canEditUser(user)"
                        [class.opacity-50]="!canEditUser(user)"
                        [class.cursor-not-allowed]="!canEditUser(user)"
                        class="users-card-select">
                  <option value="ADMIN">Admin</option>
                  <option value="STUDENT">Aluno</option>
                  <option value="TEACHER">Professor</option>
                </select>
              </ng-container>
              <ng-template #viewRole>
                <span class="users-card-value">{{ user.role }}</span>
              </ng-template>
            </div>
            
            <div class="users-card-field">
              <span class="users-card-label">Status:</span>
              <ng-container *ngIf="editUserId === user.id; else viewStatus">
                <select [(ngModel)]="editIsActive" 
                        [disabled]="!canEditUser(user)"
                        [class.opacity-50]="!canEditUser(user)"
                        [class.cursor-not-allowed]="!canEditUser(user)"
                        class="users-card-select">
                  <option [ngValue]="true">Ativo</option>
                  <option [ngValue]="false">Inativo</option>
                </select>
              </ng-container>
              <ng-template #viewStatus>
                <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                  {{ user.isActive ? 'Ativo' : 'Inativo' }}
                </span>
              </ng-template>
            </div>
          </div>
          
          <div class="users-card-actions">
            <ng-container *ngIf="editUserId === user.id; else editDeleteBtns">
              <button (click)="saveEdit(user)" 
                      [disabled]="!canEditUser(user)"
                      [class.opacity-50]="!canEditUser(user)"
                      [class.cursor-not-allowed]="!canEditUser(user)"
                      class="users-action-btn users-action-save">
                <span class="material-icons">check</span>
                Salvar
              </button>
              <button (click)="cancelEdit()" class="users-action-btn users-action-cancel">
                <span class="material-icons">close</span>
                Cancelar
              </button>
            </ng-container>
            <ng-template #editDeleteBtns>
              <button *ngIf="canEditUser(user)" (click)="startEdit(user)" class="users-action-btn users-action-edit">
                <span class="material-icons">edit</span>
                Editar
              </button>
              <button *ngIf="canEditUser(user)" (click)="deleteUser(user)" class="users-action-btn users-action-delete">
                <span class="material-icons">delete</span>
                Deletar
              </button>
              <span *ngIf="!canEditUser(user)" class="users-action-locked" title="Você não pode editar este usuário">
                <span class="material-icons">lock</span>
                Bloqueado
              </span>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Tabela para Desktop -->
      <div class="users-table-desktop">
        <table class="users-table">
          <thead>
            <tr class="users-table-header">
              <th class="users-table-th">ID</th>
              <th class="users-table-th">E-mail</th>
              <th class="users-table-th">Tipo</th>
              <th class="users-table-th">Status</th>
              <th class="users-table-th users-table-th-actions">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers" class="users-table-row">
              <td class="users-table-td">{{ user.id }}</td>
              <td class="users-table-td">{{ user.email }}</td>
              <td class="users-table-td">
                <ng-container *ngIf="editUserId === user.id; else viewRole">
                  <select [(ngModel)]="editRole" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-select">
                    <option value="ADMIN">Admin</option>
                    <option value="STUDENT">Aluno</option>
                    <option value="TEACHER">Professor</option>
                  </select>
                </ng-container>
                <ng-template #viewRole>{{ user.role }}</ng-template>
              </td>
              <td class="users-table-td">
                <ng-container *ngIf="editUserId === user.id; else viewStatus">
                  <select [(ngModel)]="editIsActive" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-select">
                    <option [ngValue]="true">Ativo</option>
                    <option [ngValue]="false">Inativo</option>
                  </select>
                </ng-container>
                <ng-template #viewStatus>
                  <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                    {{ user.isActive ? 'Ativo' : 'Inativo' }}
                  </span>
                </ng-template>
              </td>
              <td class="users-table-td users-table-td-actions">
                <ng-container *ngIf="editUserId === user.id; else editDeleteBtns">
                  <button (click)="saveEdit(user)" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-action users-table-action-save">
                    <span class="material-icons">check</span>
                  </button>
                  <button (click)="cancelEdit()" class="users-table-action users-table-action-cancel">
                    <span class="material-icons">close</span>
                  </button>
                </ng-container>
                <ng-template #editDeleteBtns>
                  <button *ngIf="canEditUser(user)" (click)="startEdit(user)" class="users-table-action users-table-action-edit">
                    <span class="material-icons">edit</span>
                  </button>
                  <button *ngIf="canEditUser(user)" (click)="deleteUser(user)" class="users-table-action users-table-action-delete">
                    <span class="material-icons">delete</span>
                  </button>
                  <span *ngIf="!canEditUser(user)" class="users-table-action users-table-action-locked" title="Você não pode editar este usuário">
                    <span class="material-icons">lock</span>
                  </span>
                </ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer com informações -->
    <div class="users-footer">
      <div class="users-footer-info">
        Mostrando {{ filteredUsers.length }} de {{ users.length }} usuários
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<app-modal
  [isOpen]="showModal"
  [title]="modalTitle"
  [message]="modalMessage"
  [type]="modalType"
  (close)="showModal = false">
</app-modal>
