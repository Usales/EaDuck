<app-sidebar></app-sidebar>
<div class="users-container page-bg">
  <!-- Header Mobile First -->
  <div class="users-header">
    <div class="users-header-content">
      <h1 class="users-title">Usuários</h1>
      <button *ngIf="isAdmin" (click)="toggleNewUserForm()" class="users-add-btn">
        <span class="material-icons">{{ showNewUserForm ? 'close' : 'add' }}</span>
        <span class="users-add-text">{{ showNewUserForm ? 'Cancelar' : 'Novo Usuário' }}</span>
      </button>
    </div>
  </div>

  <!-- Formulário de Novo Usuário Mobile First -->
  <div *ngIf="isAdmin && showNewUserForm" class="users-form">
    <h2 class="users-form-title">Criar Novo Usuário</h2>
    <div class="users-form-grid">
      <div class="users-form-field">
        <label class="users-form-label">E-mail <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">email</span>
          </span>
          <input type="email" [(ngModel)]="newUser.email" 
                 class="users-form-input"
                 placeholder="Digite o e-mail">
        </div>
      </div>
      
      <div class="users-form-field">
        <label class="users-form-label">Senha <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">lock</span>
          </span>
          <input type="password" [(ngModel)]="newUser.password" 
                 class="users-form-input"
                 placeholder="Digite a senha">
        </div>
        <div class="users-form-password-strength">
          <div class="users-form-strength-bar"
               [ngClass]="{
                 'strength-weak': passwordStrength <= 1,
                 'strength-medium': passwordStrength === 2,
                 'strength-strong': passwordStrength === 3 || passwordStrength === 4,
                 'strength-very-strong': passwordStrength === 5
               }"
               [style.width]="(passwordStrength * 20) + '%'">
          </div>
          <span class="users-form-strength-text" [ngClass]="{
            'text-red-400': passwordStrength <= 1,
            'text-yellow-400': passwordStrength === 2,
            'text-green-400': passwordStrength === 3 || passwordStrength === 4,
            'text-blue-400': passwordStrength === 5
          }">Força da senha: {{ passwordStrengthLabel }}</span>
        </div>
        <p class="users-form-help">A senha deve ter pelo menos 6 caracteres</p>
      </div>
      
      <div class="users-form-field">
        <label class="users-form-label">Tipo de Usuário <span class="text-red-500">*</span></label>
        <div class="users-form-input-wrapper">
          <span class="users-form-icon">
            <span class="material-icons">person</span>
          </span>
          <select [(ngModel)]="newUser.role" class="users-form-select">
            <option value="ADMIN">Admin</option>
            <option value="STUDENT">Estudante</option>
            <option value="TEACHER">Professor</option>
          </select>
          <span class="users-form-select-arrow">
            <span class="material-icons">arrow_drop_down</span>
          </span>
        </div>
      </div>
      
      <div class="users-form-actions">
        <button (click)="createUser()" class="users-form-submit">
          <span class="material-icons">save</span>
          Criar Usuário
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de Usuários Mobile First -->
  <div class="users-list">
    <!-- Barra de Busca e Filtros -->
    <div class="users-search">
      <div class="users-search-wrapper">
        <span class="users-search-icon">
          <span class="material-icons">search</span>
        </span>
        <input type="text" placeholder="Buscar usuários..." [(ngModel)]="filter" (input)="applyFilter()" class="users-search-input">
      </div>
    </div>

    <!-- Filtros -->
    <div class="users-filters">
      <div class="users-filter-group">
        <label class="users-filter-label">Filtrar por Tipo:</label>
        <select [(ngModel)]="filterRole" (change)="applyFilter()" class="users-filter-select">
          <option value="all">Todos os tipos</option>
          <option value="ADMIN">Admin</option>
          <option value="STUDENT">Estudante</option>
          <option value="TEACHER">Professor</option>
        </select>
      </div>
      <div class="users-filter-group">
        <label class="users-filter-label">Filtrar por Status:</label>
        <select [(ngModel)]="filterStatus" (change)="applyFilter()" class="users-filter-select">
          <option value="all">Todos os status</option>
          <option value="active">Ativo</option>
          <option value="inactive">Inativo</option>
        </select>
      </div>
      <div class="users-filter-group">
        <button (click)="clearFilters()" class="users-filter-clear">
          Limpar Filtros
        </button>
      </div>
      <div class="users-filter-group" *ngIf="isAdminOrTeacher">
        <button (click)="exportUsersToPdf()" class="users-export-pdf-btn">
          <span class="material-icons">picture_as_pdf</span>
          Exportar PDF
        </button>
      </div>
    </div>

    <!-- Cards Mobile / Tabela Desktop -->
    <div class="users-content">
      <!-- Cards para Mobile -->
      <div class="users-cards-mobile">
        <div *ngFor="let user of filteredUsers" class="users-card">
          <div class="users-card-header">
            <div class="users-card-info">
              <h3 class="users-card-email">{{ user.email }}</h3>
              <span class="users-card-id">ID: {{ user.id }}</span>
            </div>
            <div class="users-card-status">
              <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                {{ user.isActive ? 'Ativo' : 'Inativo' }}
              </span>
            </div>
          </div>
          
          <div class="users-card-body">
            <div class="users-card-field" *ngIf="user.name || user.nomeCompleto">
              <span class="users-card-label">Nome:</span>
              <span class="users-card-value">{{ user.name || user.nomeCompleto || '-' }}</span>
              <button *ngIf="hasUserDetails(user)" 
                      (click)="showUserDetails(user)" 
                      class="users-action-btn users-action-info"
                      title="Ver detalhes">
                <span class="material-icons">info</span>
              </button>
            </div>
            <div class="users-card-field">
              <span class="users-card-label">Tipo:</span>
              <ng-container *ngIf="editUserId === user.id; else viewRole">
                <select [(ngModel)]="editRole" 
                        [disabled]="!canEditUser(user)"
                        [class.opacity-50]="!canEditUser(user)"
                        [class.cursor-not-allowed]="!canEditUser(user)"
                        class="users-card-select">
                  <option value="ADMIN">Admin</option>
                  <option value="STUDENT">Estudante</option>
                  <option value="TEACHER">Professor</option>
                </select>
              </ng-container>
              <ng-template #viewRole>
                <span class="users-card-value">{{ getRoleLabel(user.role) }}</span>
              </ng-template>
            </div>
            
            <div class="users-card-field">
              <span class="users-card-label">Status:</span>
              <ng-container *ngIf="editUserId === user.id; else viewStatus">
                <select [(ngModel)]="editIsActive" 
                        [disabled]="!canEditUser(user)"
                        [class.opacity-50]="!canEditUser(user)"
                        [class.cursor-not-allowed]="!canEditUser(user)"
                        class="users-card-select">
                  <option [ngValue]="true">Ativo</option>
                  <option [ngValue]="false">Inativo</option>
                </select>
              </ng-container>
              <ng-template #viewStatus>
                <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                  {{ user.isActive ? 'Ativo' : 'Inativo' }}
                </span>
              </ng-template>
            </div>
          </div>
          
          <div class="users-card-actions">
            <ng-container *ngIf="editUserId === user.id; else editDeleteBtns">
              <button (click)="saveEdit(user)" 
                      [disabled]="!canEditUser(user)"
                      [class.opacity-50]="!canEditUser(user)"
                      [class.cursor-not-allowed]="!canEditUser(user)"
                      class="users-action-btn users-action-save">
                <span class="material-icons">check</span>
                Salvar
              </button>
              <button (click)="cancelEdit()" class="users-action-btn users-action-cancel">
                <span class="material-icons">close</span>
                Cancelar
              </button>
            </ng-container>
            <ng-template #editDeleteBtns>
              <button *ngIf="hasUserDetails(user)" 
                      (click)="showUserDetails(user)" 
                      class="users-action-btn users-action-info"
                      title="Ver detalhes">
                <span class="material-icons">info</span>
                Detalhes
              </button>
              <button *ngIf="canEditUser(user)" (click)="startEdit(user)" class="users-action-btn users-action-edit">
                <span class="material-icons">edit</span>
                Editar
              </button>
              <button *ngIf="canEditUser(user)" (click)="deleteUser(user)" class="users-action-btn users-action-delete">
                <span class="material-icons">delete</span>
                Deletar
              </button>
              <span *ngIf="!canEditUser(user)" class="users-action-locked" title="Você não pode editar este usuário">
                <span class="material-icons">lock</span>
                Bloqueado
              </span>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Tabela para Desktop -->
      <div class="users-table-desktop">
        <table class="users-table">
          <thead>
            <tr class="users-table-header">
              <th class="users-table-th">ID</th>
              <th class="users-table-th">E-mail</th>
              <th class="users-table-th">Nome</th>
              <th class="users-table-th">Tipo</th>
              <th class="users-table-th">Status</th>
              <th class="users-table-th users-table-th-actions">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers" class="users-table-row">
              <td class="users-table-td">{{ user.id }}</td>
              <td class="users-table-td">{{ user.email }}</td>
              <td class="users-table-td">
                {{ user.name || user.nomeCompleto || '-' }}
              </td>
              <td class="users-table-td">
                <ng-container *ngIf="editUserId === user.id; else viewRole">
                  <select [(ngModel)]="editRole" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-select">
                    <option value="ADMIN">Admin</option>
                    <option value="STUDENT">Estudante</option>
                    <option value="TEACHER">Professor</option>
                  </select>
                </ng-container>
                <ng-template #viewRole>{{ getRoleLabel(user.role) }}</ng-template>
              </td>
              <td class="users-table-td">
                <ng-container *ngIf="editUserId === user.id; else viewStatus">
                  <select [(ngModel)]="editIsActive" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-select">
                    <option [ngValue]="true">Ativo</option>
                    <option [ngValue]="false">Inativo</option>
                  </select>
                </ng-container>
                <ng-template #viewStatus>
                  <span [ngClass]="user.isActive ? 'users-status-active' : 'users-status-inactive'">
                    {{ user.isActive ? 'Ativo' : 'Inativo' }}
                  </span>
                </ng-template>
              </td>
              <td class="users-table-td users-table-td-actions">
                <ng-container *ngIf="editUserId === user.id; else editDeleteBtns">
                  <button (click)="saveEdit(user)" 
                          [disabled]="!canEditUser(user)"
                          [class.opacity-50]="!canEditUser(user)"
                          [class.cursor-not-allowed]="!canEditUser(user)"
                          class="users-table-action users-table-action-save">
                    <span class="material-icons">check</span>
                  </button>
                  <button (click)="cancelEdit()" class="users-table-action users-table-action-cancel">
                    <span class="material-icons">close</span>
                  </button>
                </ng-container>
                <ng-template #editDeleteBtns>
                  <button *ngIf="hasUserDetails(user)" 
                          (click)="showUserDetails(user)" 
                          class="users-table-action users-table-action-info"
                          title="Ver detalhes">
                    <span class="material-icons">info</span>
                  </button>
                  <button *ngIf="canEditUser(user)" (click)="startEdit(user)" class="users-table-action users-table-action-edit">
                    <span class="material-icons">edit</span>
                  </button>
                  <button *ngIf="canEditUser(user)" (click)="deleteUser(user)" class="users-table-action users-table-action-delete">
                    <span class="material-icons">delete</span>
                  </button>
                  <span *ngIf="!canEditUser(user)" class="users-table-action users-table-action-locked" title="Você não pode editar este usuário">
                    <span class="material-icons">lock</span>
                  </span>
                </ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer com informações -->
    <div class="users-footer">
      <div class="users-footer-info">
        Mostrando {{ filteredUsers.length }} de {{ users.length }} usuários
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<app-modal
  [isOpen]="showModal"
  [title]="modalTitle"
  [message]="modalMessage"
  [type]="modalType"
  (close)="showModal = false">
</app-modal>

<!-- Modal de Detalhes do Usuário -->
<div *ngIf="showUserDetailsModal && selectedUser" class="users-confirm-modal-overlay" (click)="closeUserDetails()">
  <div class="users-confirm-modal-content" (click)="$event.stopPropagation()">
    <div class="users-confirm-modal-header">
      <div class="users-confirm-modal-title-wrapper">
        <span class="material-icons users-confirm-modal-icon">person</span>
        <h2 class="users-confirm-modal-title">Detalhes do Usuário</h2>
      </div>
      <button (click)="closeUserDetails()" class="users-confirm-modal-close">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="users-details-content">
      <div class="users-details-section">
        <h3 class="users-details-section-title">Informações Básicas</h3>
        <div class="users-details-grid">
          <div class="users-details-item">
            <span class="users-details-label">E-mail:</span>
            <span class="users-details-value">{{ selectedUser.email }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.name">
            <span class="users-details-label">Apelido/Nickname:</span>
            <span class="users-details-value">{{ selectedUser.name }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.nomeCompleto">
            <span class="users-details-label">Nome Completo:</span>
            <span class="users-details-value">{{ selectedUser.nomeCompleto }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.cpf">
            <span class="users-details-label">CPF:</span>
            <span class="users-details-value">{{ selectedUser.cpf }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.dataNascimento">
            <span class="users-details-label">Data de Nascimento:</span>
            <span class="users-details-value">{{ selectedUser.dataNascimento }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.telefone">
            <span class="users-details-label">Telefone:</span>
            <span class="users-details-value">{{ selectedUser.telefone }}</span>
          </div>
        </div>
      </div>
      
      <div class="users-details-section" *ngIf="selectedUser.nomeMae || selectedUser.nomePai">
        <h3 class="users-details-section-title">Informações Familiares</h3>
        <div class="users-details-grid">
          <div class="users-details-item" *ngIf="selectedUser.nomeMae">
            <span class="users-details-label">Nome da Mãe:</span>
            <span class="users-details-value">{{ selectedUser.nomeMae }}</span>
          </div>
          <div class="users-details-item" *ngIf="selectedUser.nomePai">
            <span class="users-details-label">Nome do Pai:</span>
            <span class="users-details-value">{{ selectedUser.nomePai }}</span>
          </div>
        </div>
      </div>
      
      <div class="users-details-section" *ngIf="selectedUser.endereco || selectedUser.titulacao">
        <h3 class="users-details-section-title" *ngIf="selectedUser.endereco">Endereço</h3>
        <div class="users-details-item" *ngIf="selectedUser.endereco">
          <span class="users-details-label">Endereço:</span>
          <span class="users-details-value">{{ selectedUser.endereco }}</span>
        </div>
        <h3 class="users-details-section-title" *ngIf="selectedUser.titulacao" style="margin-top: 1rem;">Titulação</h3>
        <div class="users-details-item" *ngIf="selectedUser.titulacao">
          <span class="users-details-label">Titulação:</span>
          <span class="users-details-value">{{ selectedUser.titulacao }}</span>
        </div>
      </div>
      
      <div class="users-details-section">
        <h3 class="users-details-section-title">Informações do Sistema</h3>
        <div class="users-details-grid">
          <div class="users-details-item">
            <span class="users-details-label">ID:</span>
            <span class="users-details-value">{{ selectedUser.id }}</span>
          </div>
          <div class="users-details-item">
            <span class="users-details-label">Tipo:</span>
            <span class="users-details-value">{{ getRoleLabel(selectedUser.role) }}</span>
          </div>
          <div class="users-details-item">
            <span class="users-details-label">Status:</span>
            <span [ngClass]="selectedUser.isActive ? 'users-status-active' : 'users-status-inactive'">
              {{ selectedUser.isActive ? 'Ativo' : 'Inativo' }}
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="users-confirm-modal-actions">
      <button (click)="closeUserDetails()" class="users-confirm-modal-btn users-confirm-modal-btn-cancel">
        <span class="material-icons">close</span>
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div *ngIf="showConfirmModal" class="users-confirm-modal-overlay" (click)="onConfirmModalOverlayClick($event)">
  <div class="users-confirm-modal-content">
    <div class="users-confirm-modal-header">
      <div class="users-confirm-modal-title-wrapper">
        <span class="material-icons users-confirm-modal-icon">warning</span>
        <h2 class="users-confirm-modal-title">{{ confirmModalTitle }}</h2>
      </div>
      <button (click)="cancelDelete()" class="users-confirm-modal-close">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="users-confirm-modal-message" [innerHTML]="confirmModalMessage"></div>
    <div class="users-confirm-modal-actions">
      <button (click)="cancelDelete()" class="users-confirm-modal-btn users-confirm-modal-btn-cancel">
        <span class="material-icons">close</span>
        Cancelar
      </button>
      <button (click)="confirmDelete()" class="users-confirm-modal-btn users-confirm-modal-btn-delete">
        <span class="material-icons">delete</span>
        Deletar
      </button>
    </div>
  </div>
</div>
