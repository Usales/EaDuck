<app-sidebar></app-sidebar>

<div class="attendance-container">
  <!-- Lista de Salas -->
  <div *ngIf="!selectedClassroom" class="classrooms-list">
    <div class="page-header">
      <h1>Frequência</h1>
      <p class="subtitle">Selecione uma sala para registrar a frequência</p>
    </div>

    <div *ngIf="loading" class="loading-state">
      <p>Carregando salas...</p>
    </div>

    <div *ngIf="!loading && classrooms.length === 0" class="empty-state">
      <p>Nenhuma sala disponível</p>
      <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);">
        Você precisa ter acesso a pelo menos uma sala para registrar frequências.
      </p>
    </div>

    <div *ngIf="!loading && classrooms.length > 0" class="classrooms-grid">
      <div 
        *ngFor="let classroom of classrooms" 
        class="classroom-card">
        <div class="classroom-header">
          <h3>{{ classroom.name }}</h3>
        </div>
        <div class="classroom-info">
          <div class="info-item">
            <span class="label">Série / Ano:</span>
            <span class="value">{{ classroom.academicYear || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Alunos:</span>
            <span class="value">{{ classroom.studentCount }}</span>
          </div>
          <div class="info-item">
            <span class="label">Professor:</span>
            <span class="value">{{ classroom.teacherName || '-' }}</span>
          </div>
        </div>
        <div class="classroom-actions">
          <button (click)="selectClassroom(classroom); $event.stopPropagation()" class="action-btn primary">
            <span class="material-icons">edit</span>
            Registrar Frequência
          </button>
          <button (click)="viewAttendance(classroom); $event.stopPropagation()" class="action-btn secondary">
            <span class="material-icons">visibility</span>
            Ver Frequência
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Visualização de Frequências -->
  <div *ngIf="selectedClassroom && viewMode === 'view'" class="attendance-view">
    <div class="view-header">
      <button (click)="backToClassrooms()" class="back-button">
        <span class="material-icons">arrow_back</span>
        Voltar
      </button>
      <div class="header-info">
        <h1>Histórico de Frequências</h1>
        <div class="classroom-info">
          <span><strong>Nome da Sala:</strong> {{ selectedClassroom.name }}</span>
          <span><strong>Ano Letivo:</strong> {{ selectedClassroom.academicYear }}</span>
        </div>
        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
          Visualize todas as frequências registradas de todos os alunos em dias anteriores
        </p>
      </div>
    </div>

    <div *ngIf="loading" class="loading-state">
      <p>Carregando frequências...</p>
    </div>

    <div *ngIf="!loading && filteredAttendances.length === 0" class="empty-state">
      <p>Nenhuma frequência encontrada com os filtros selecionados.</p>
    </div>

    <div *ngIf="!loading && filteredAttendances.length > 0" class="content">
      <!-- Filtros -->
      <div class="filters">
        <div class="filter-group">
          <label for="dateFilter">Data</label>
          <input 
            type="date" 
            id="dateFilter" 
            [(ngModel)]="dateFilter"
            class="date-filter-input">
        </div>
        <div class="filter-group">
          <label for="disciplineFilter">Disciplina</label>
          <select id="disciplineFilter" [(ngModel)]="disciplineFilter">
            <option value="">Todas</option>
            <option *ngFor="let disc of uniqueDisciplines" [value]="disc">
              {{ disc }}
            </option>
          </select>
        </div>
        <div class="filter-group">
          <label for="studentFilter">Aluno</label>
          <select id="studentFilter" [(ngModel)]="studentFilter">
            <option value="">Todos</option>
            <option *ngFor="let student of uniqueStudents" [value]="student.id">
              {{ student.name }}
            </option>
          </select>
        </div>
        <div class="filter-group">
          <button 
            (click)="dateFilter = ''; disciplineFilter = ''; studentFilter = ''" 
            class="clear-filters-btn"
            title="Limpar filtros">
            <span class="material-icons">clear</span>
            Limpar Filtros
          </button>
        </div>
      </div>

      <!-- Tabela de Frequências -->
      <div class="table-wrapper">
        <table class="grades-table">
          <thead>
            <tr>
              <th>NOME DO ALUNO</th>
              <th>DISCIPLINA</th>
              <th>DATA</th>
              <th>PERÍODO</th>
              <th>STATUS</th>
              <th>HORÁRIO</th>
              <th>OBSERVAÇÕES</th>
              <th>AÇÕES</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let attendance of filteredAttendances; let i = index" 
                [class.new-student-row]="isNewStudentRow(i)">
              <td class="student-name" *ngIf="shouldShowStudentInfo(i)">{{ getStudentDisplayName(attendance.studentName) }}</td>
              <td class="student-name" *ngIf="!shouldShowStudentInfo(i)"></td>
              <td class="discipline">{{ attendance.discipline || '-' }}</td>
              <td class="date">{{ formatDateDisplayFromString(attendance.date) }}</td>
              <td class="period">{{ attendance.period || '-' }}</td>
              <td class="status-cell">
                <span [class]="'status-badge ' + attendance.status.toLowerCase()">
                  {{ getStatusIcon(attendance.status) }} {{ getStatusLabel(attendance.status) }}
                </span>
              </td>
              <td class="time">{{ attendance.arrivalTime || '-' }}</td>
              <td class="observations">{{ attendance.observations || '-' }}</td>
              <td class="actions">
                <button 
                  (click)="viewStudentHistory(attendance.studentId)" 
                  class="history-btn"
                  title="Ver histórico">
                  <span class="material-icons">history</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ficha de Presença -->
  <div *ngIf="selectedClassroom && viewMode === 'register'" class="attendance-sheet">
    <div class="sheet-header">
      <button (click)="backToClassrooms()" class="back-button">
        <span class="material-icons">arrow_back</span>
        Voltar
      </button>
      <h1>Ficha de Frequência - {{ selectedClassroom.name }}</h1>
    </div>

    <!-- Navegação de Data -->
    <div class="date-navigation">
      <button (click)="previousDay()" class="nav-button" type="button">
        <span class="material-icons">chevron_left</span>
        <span class="nav-button-text">Anterior</span>
      </button>
      
      <div class="date-display">
        <input 
          type="date" 
          [value]="getDateInputValue()" 
          (change)="onDateChange($event)"
          class="date-input"
          title="Selecione a data">
        <span class="date-text">{{ formatDateDisplay(currentDate) }}</span>
      </div>
      
      <button (click)="nextDay()" class="nav-button" type="button">
        <span class="nav-button-text">Próximo</span>
        <span class="material-icons">chevron_right</span>
      </button>
    </div>

    <!-- Informações da Ficha -->
    <div class="sheet-info">
      <div class="info-field">
        <label>Disciplina (opcional):</label>
        <select 
          [(ngModel)]="discipline" 
          class="info-select"
          [disabled]="loadingDisciplines">
          <option value="">Selecione uma disciplina</option>
          <option *ngFor="let disc of disciplines" [value]="disc.name">
            {{ disc.name }}
          </option>
        </select>
        <small *ngIf="loadingDisciplines" style="color: var(--text-secondary); font-size: 0.75rem;">
          Carregando disciplinas...
        </small>
      </div>
      <div class="info-field">
        <label>Período:</label>
        <select [(ngModel)]="period" class="info-select">
          <option value="MANHA">Manhã</option>
          <option value="TARDE">Tarde</option>
          <option value="INTEGRAL">Integral</option>
        </select>
      </div>
    </div>

    <!-- Planilha de Presença -->
    <div *ngIf="loading" class="loading-state">
      <p>Carregando frequência...</p>
    </div>

    <div *ngIf="!loading" class="attendance-table-wrapper">
      <table class="attendance-table">
        <thead>
          <tr>
            <th>Nº</th>
            <th>Nome do Aluno</th>
            <th class="mobile-hide">Presente (✔)</th>
            <th class="mobile-hide">Ausente (✘)</th>
            <th class="mobile-hide">Atrasado (⏱)</th>
            <th>Status</th>
            <th class="mobile-hide">Horário</th>
            <th class="mobile-hide">Observações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let attendance of attendances; let i = index">
            <td class="number-cell">{{ i + 1 }}</td>
            <td class="name-cell">{{ attendance.studentName }}</td>
            <td class="status-cell mobile-hide">
              <button 
                (click)="updateAttendanceStatus(attendance, 'PRESENT')"
                [class.active]="attendance.status === 'PRESENT'"
                [disabled]="!canEditAttendance(attendance)"
                class="status-button present"
                type="button"
                [title]="canEditAttendance(attendance) ? 'Presente' : 'Não é possível editar após 1 dia'">
                ✔
              </button>
            </td>
            <td class="status-cell mobile-hide">
              <button 
                (click)="updateAttendanceStatus(attendance, 'ABSENT')"
                [class.active]="attendance.status === 'ABSENT'"
                [disabled]="!canEditAttendance(attendance)"
                class="status-button absent"
                type="button"
                [title]="canEditAttendance(attendance) ? 'Ausente' : 'Não é possível editar após 1 dia'">
                ✘
              </button>
            </td>
            <td class="status-cell mobile-hide">
              <button 
                (click)="updateAttendanceStatus(attendance, 'LATE')"
                [class.active]="attendance.status === 'LATE'"
                [disabled]="!canEditAttendance(attendance)"
                class="status-button late"
                type="button"
                [title]="canEditAttendance(attendance) ? 'Atrasado' : 'Não é possível editar após 1 dia'">
                ⏱
              </button>
            </td>
            <td class="status-cell mobile-only">
              <div class="status-buttons-group">
                <button 
                  (click)="updateAttendanceStatus(attendance, 'PRESENT')"
                  [class.active]="attendance.status === 'PRESENT'"
                  [disabled]="!canEditAttendance(attendance)"
                  class="status-button present"
                  type="button"
                  [title]="canEditAttendance(attendance) ? 'Presente' : 'Não é possível editar após 1 dia'">
                  ✔
                </button>
                <button 
                  (click)="updateAttendanceStatus(attendance, 'ABSENT')"
                  [class.active]="attendance.status === 'ABSENT'"
                  [disabled]="!canEditAttendance(attendance)"
                  class="status-button absent"
                  type="button"
                  [title]="canEditAttendance(attendance) ? 'Ausente' : 'Não é possível editar após 1 dia'">
                  ✘
                </button>
                <button 
                  (click)="updateAttendanceStatus(attendance, 'LATE')"
                  [class.active]="attendance.status === 'LATE'"
                  [disabled]="!canEditAttendance(attendance)"
                  class="status-button late"
                  type="button"
                  [title]="canEditAttendance(attendance) ? 'Atrasado' : 'Não é possível editar após 1 dia'">
                  ⏱
                </button>
              </div>
            </td>
            <td class="time-cell mobile-hide">
              <input 
                *ngIf="attendance.status === 'LATE'"
                type="time" 
                [(ngModel)]="attendance.arrivalTime"
                class="time-input">
              <span *ngIf="attendance.status !== 'LATE'" class="time-placeholder">-</span>
            </td>
            <td class="observations-cell mobile-hide">
              <input 
                type="text" 
                [(ngModel)]="attendance.observations"
                placeholder="Observações..."
                class="observations-input">
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Resumo Automático -->
    <div class="summary-section">
      <h3>Resumo da Frequência</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Total de Alunos:</span>
          <span class="summary-value">{{ totalStudents }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Presentes:</span>
          <span class="summary-value present">{{ presentCount }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Ausentes:</span>
          <span class="summary-value absent">{{ absentCount }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Atrasados:</span>
          <span class="summary-value late">{{ lateCount }}</span>
        </div>
        <div class="summary-item highlight">
          <span class="summary-label">Percentual de Presença:</span>
          <span class="summary-value">{{ attendancePercentage.toFixed(2) }}%</span>
        </div>
      </div>
    </div>

    <!-- Ações -->
    <div class="actions-section">
      <button 
        (click)="saveAttendance()" 
        [disabled]="saving"
        class="action-button save"
        [title]="!canEditCurrentDate() ? 'Você pode registrar frequências para hoje ou até 7 dias no futuro' : 'Salvar frequência (será sincronizada automaticamente)'">
        <span class="material-icons">save</span>
        {{ saving ? 'Salvando...' : 'Salvar Frequência' }}
      </button>
      <button 
        *ngIf="canViewAttendance()"
        (click)="viewAllStudentsHistory()" 
        class="action-button history">
        <span class="material-icons">history</span>
        Ver Histórico de Alunos
      </button>
      <button 
        *ngIf="canViewAttendance()"
        (click)="viewAttendance(selectedClassroom!)" 
        class="action-button view">
        <span class="material-icons">visibility</span>
        Ver Frequência
      </button>
      <button 
        (click)="exportToPdf()" 
        class="action-button export">
        <span class="material-icons">picture_as_pdf</span>
        Exportar PDF
      </button>
    </div>
  </div>

  <!-- Modal de Histórico do Aluno -->
  <div *ngIf="showHistoryModal" class="modal-overlay" (click)="closeHistoryModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Histórico de Frequência</h2>
        <div *ngIf="selectedStudentForHistory && uniqueStudents.length > 0" class="student-name-header">
          <p>{{ getStudentNameById(selectedStudentForHistory) }}</p>
        </div>
        <button (click)="closeHistoryModal()" class="modal-close">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div *ngIf="loading" class="loading-state">
          <p>Carregando histórico...</p>
        </div>
        <div *ngIf="!loading && studentHistory.length === 0" class="empty-state">
          <p>Nenhum registro de frequência encontrado.</p>
        </div>
        <div *ngIf="!loading && studentHistory.length > 0" class="history-table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>DATA</th>
                <th>DISCIPLINA</th>
                <th>PERÍODO</th>
                <th>STATUS</th>
                <th>HORÁRIO</th>
                <th>OBSERVAÇÕES</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let record of studentHistory">
                <td>{{ formatDateDisplayFromString(record.date) }}</td>
                <td>{{ record.discipline || '-' }}</td>
                <td>{{ record.period || '-' }}</td>
                <td>
                  <span [class]="'status-badge ' + record.status.toLowerCase()">
                    {{ getStatusIcon(record.status) }} {{ getStatusLabel(record.status) }}
                  </span>
                </td>
                <td>{{ record.arrivalTime || '-' }}</td>
                <td>{{ record.observations || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

